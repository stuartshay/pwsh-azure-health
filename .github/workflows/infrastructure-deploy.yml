name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: 'dev'
      sku:
        description: 'Function App hosting plan SKU'
        required: true
        type: choice
        options:
          - Y1
          - EP1
        default: 'Y1'

permissions:
  contents: read
  id-token: write

env:
  MAX_RETRY_ATTEMPTS: 5
  RETRY_BASE_DELAY: 2

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set environment variables
        run: |
          echo "RESOURCE_GROUP=rg-azure-health-${{ github.event.inputs.environment }}" >> "$GITHUB_ENV"
          echo "LOCATION=eastus" >> "$GITHUB_ENV"

      - name: Setup CI utilities
        shell: bash
        run: |
          # Copy retry utilities from source
          cp scripts/ci/retry-utils.sh /tmp/retry-utils.sh
          chmod +x /tmp/retry-utils.sh
          echo "‚úÖ Retry utilities configured (max attempts: $MAX_RETRY_ATTEMPTS, base delay: ${RETRY_BASE_DELAY}s)"

          # Copy policy query utilities from source
          cp scripts/ci/policy-query.sh /tmp/policy-query.sh
          chmod +x /tmp/policy-query.sh
          echo "‚úÖ Policy query utilities configured"

          # Copy Key Vault utilities from source
          cp scripts/ci/keyvault-utils.sh /tmp/keyvault-utils.sh
          chmod +x /tmp/keyvault-utils.sh
          echo "‚úÖ Key Vault utilities configured"

          # Copy deployment verification utilities from source
          cp scripts/ci/deployment-verification.sh /tmp/deployment-verification.sh
          chmod +x /tmp/deployment-verification.sh
          echo "‚úÖ Deployment verification utilities configured"

      - name: Install cost estimation tools
        shell: bash
        run: |
          echo "üí∞ Installing cost estimation tools..."

          # Install ACE (Azure Cost Estimator) for Bicep cost estimation
          echo "üì¶ Installing ACE (Azure Cost Estimator) v1.6.4..."
          wget -q https://github.com/TheCloudTheory/arm-estimator/releases/download/1.6.4/linux-x64.zip -O /tmp/ace.zip
          unzip -q /tmp/ace.zip -d /tmp/ace
          chmod +x /tmp/ace/azure-cost-estimator
          /tmp/ace/azure-cost-estimator --version
          echo "‚úÖ ACE installed successfully"

          # Install azure-cost-cli for actual cost analysis (via .NET tool)
          echo "üì¶ Installing azure-cost-cli v0.52.0..."
          dotnet tool install --global azure-cost-cli --version 0.52.0 || dotnet tool update --global azure-cost-cli --version 0.52.0
          # Ensure dotnet tools are in PATH for subsequent steps
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"
          echo "‚úÖ azure-cost-cli installed successfully"

      - name: Create resource group if not exists
        shell: bash
        run: |
          source /tmp/retry-utils.sh

          # Check if resource group exists (use az group show instead of exists for reliability)
          if az group show --name "$RESOURCE_GROUP" > /dev/null 2>&1; then
            echo "‚úÖ Resource group already exists: $RESOURCE_GROUP"
            exit 0
          fi

          # Create resource group with retry logic
          echo "üì¶ Creating resource group: $RESOURCE_GROUP"
          retry_azure_operation \
            "$MAX_RETRY_ATTEMPTS" \
            "Create resource group $RESOURCE_GROUP" \
            az group create \
              --name "$RESOURCE_GROUP" \
              --location "$LOCATION" \
              --tags environment=${{ github.event.inputs.environment }} project=azure-health \
              --output none

          # Verify resource group was created
          echo "üîç Verifying resource group creation..."
          if ! az group show --name "$RESOURCE_GROUP" > /dev/null 2>&1; then
            echo "‚ùå Resource group verification failed: $RESOURCE_GROUP was not created"
            exit 1
          fi
          echo "‚úÖ Resource group verified: $RESOURCE_GROUP"

      - name: Get managed identity from shared infrastructure
        id: get_identity
        shell: bash
        run: |
          echo "üîç Retrieving managed identity from shared infrastructure..."

          # Query Azure for the shared managed identity
          SHARED_RG="rg-azure-health-shared"
          IDENTITY_NAME="id-azurehealth-shared"

          # Check if shared resource group exists
          if ! az group show --name "$SHARED_RG" --output none 2>/dev/null; then
            echo "‚ùå Error: Shared resource group '$SHARED_RG' not found"
            echo ""
            echo "The shared infrastructure has not been set up. Please run:"
            echo "  ./scripts/infrastructure/setup-shared-identity.ps1"
            echo ""
            echo "This will create the shared resource group and managed identity."
            exit 1
          fi

          # Get managed identity resource ID
          MANAGED_IDENTITY_RESOURCE_ID=$(az identity show \
            --name "$IDENTITY_NAME" \
            --resource-group "$SHARED_RG" \
            --query id \
            --output tsv 2>/dev/null)

          if [ -z "$MANAGED_IDENTITY_RESOURCE_ID" ] || [ "$MANAGED_IDENTITY_RESOURCE_ID" == "null" ]; then
            echo "‚ùå Error: Managed identity '$IDENTITY_NAME' not found in resource group '$SHARED_RG'"
            echo ""
            echo "Please run: ./scripts/infrastructure/setup-shared-identity.ps1"
            exit 1
          fi

          echo "‚úÖ Found managed identity: $MANAGED_IDENTITY_RESOURCE_ID"
          echo "managed_identity_resource_id=$MANAGED_IDENTITY_RESOURCE_ID" >> "$GITHUB_OUTPUT"

      - name: Estimate deployment costs (Pre-Deploy)
        id: cost_estimate
        shell: bash
        run: |
          echo "üí∞ Estimating deployment costs..."
          echo ""

          MANAGED_IDENTITY_RESOURCE_ID="${{ steps.get_identity.outputs.managed_identity_resource_id }}"

          # ========================================
          # Primary Estimator: PowerShell Script
          # ========================================
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë Primary Cost Estimator: PowerShell Script (Accurate Pricing)                ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""

          # Run PowerShell cost estimation script with validation
          PWSH_COST_OUTPUT=$(pwsh ./scripts/infrastructure/estimate-costs.ps1 \
            -Environment "${{ github.event.inputs.environment }}" \
            -Sku "${{ github.event.inputs.sku }}" \
            -Region "$LOCATION" \
            -OutputFormat both \
            -Validate 2>&1)

          PWSH_EXIT_CODE=$?

          echo "$PWSH_COST_OUTPUT"
          echo ""

          # Extract JSON from output (last complete JSON object)
          PWSH_JSON=$(echo "$PWSH_COST_OUTPUT" | awk '/^{/,/^}/' | tail -n +1)

          # Extract total cost from JSON output
          if [ -n "$PWSH_JSON" ]; then
            PWSH_TOTAL_COST=$(echo "$PWSH_JSON" | jq -r '.Costs.Total.MonthlyCost' 2>/dev/null || echo "N/A")
            PWSH_FUNCTION_COST=$(echo "$PWSH_JSON" | jq -r '.Costs.FunctionAppPlan.MonthlyCost' 2>/dev/null || echo "N/A")
            PWSH_STORAGE_COST=$(echo "$PWSH_JSON" | jq -r '.Costs.Storage.MonthlyCost' 2>/dev/null || echo "N/A")
            PWSH_AI_COST=$(echo "$PWSH_JSON" | jq -r '.Costs.ApplicationInsights.MonthlyCost' 2>/dev/null || echo "N/A")
          else
            PWSH_TOTAL_COST="N/A"
            PWSH_FUNCTION_COST="N/A"
            PWSH_STORAGE_COST="N/A"
            PWSH_AI_COST="N/A"
          fi

          if [ "$PWSH_EXIT_CODE" -ne 0 ]; then
            echo "‚ö†Ô∏è  PowerShell cost estimation validation failed (exit code: $PWSH_EXIT_CODE)"
            echo "This may indicate cost estimates are outside expected ranges."
          else
            echo "‚úÖ PowerShell cost estimation completed successfully"
            echo "üíµ Estimated monthly cost: \$$PWSH_TOTAL_COST USD"
          fi

          # ========================================
          # Secondary Estimator: ACE (Reference Only)
          # ========================================
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë Secondary Cost Estimator: ACE (Reference/Comparison)                        ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""

          # Generate ARM template from Bicep for ACE
          echo "üîß Transpiling Bicep to ARM template..."
          az bicep build \
            --file infrastructure/main.bicep \
            --outfile /tmp/main.json

          # Run ACE to estimate costs
          echo "üìä Running ACE cost estimation..."
          ACE_COST_OUTPUT=$(/tmp/ace/azure-cost-estimator \
            /tmp/main.json \
            ${{ secrets.AZURE_SUBSCRIPTION_ID }} \
            "$RESOURCE_GROUP" \
            --inline "environment=${{ github.event.inputs.environment }}" \
            --inline "functionAppPlanSku=${{ github.event.inputs.sku }}" \
            --inline "managedIdentityResourceId=$MANAGED_IDENTITY_RESOURCE_ID" \
            --currency USD 2>&1 || true)

          echo "$ACE_COST_OUTPUT"
          echo ""

          # Extract estimated monthly cost from ACE
          ACE_TOTAL_COST=$(echo "$ACE_COST_OUTPUT" | grep -i "Total cost:" | grep -oP '[\d,]+\.?\d+(?= USD)' | tail -1 || echo "N/A")

          if [ "$ACE_TOTAL_COST" = "N/A" ]; then
            echo "‚ö†Ô∏è  Could not extract cost estimate from ACE output"
            ACE_TOTAL_COST="Unable to calculate"
          else
            echo "üíµ ACE estimated monthly cost: \$$ACE_TOTAL_COST USD"
          fi

          # ========================================
          # Use PowerShell estimate as primary
          # ========================================
          # Validate cost estimate for EP1
          if [ "${{ github.event.inputs.sku }}" = "EP1" ] && [ "$PWSH_TOTAL_COST" != "N/A" ]; then
            # Check if cost is less than $100 (sanity check for EP1)
            if (( $(echo "$PWSH_TOTAL_COST < 100" | bc -l 2>/dev/null || echo 0) )); then
              echo ""
              echo "‚ùå ERROR: EP1 cost estimate (\$$PWSH_TOTAL_COST) is suspiciously low!"
              echo "Expected EP1 base cost is ~\$147/month. This indicates a pricing error."
              echo "Please review the cost configuration and estimation logic."
              exit 1
            fi
          fi

          # Save outputs
          {
            echo "pwsh_total_cost=\$$PWSH_TOTAL_COST"
            echo "ace_total_cost=\$$ACE_TOTAL_COST"
            echo "function_cost=\$$PWSH_FUNCTION_COST"
            echo "storage_cost=\$$PWSH_STORAGE_COST"
            echo "ai_cost=\$$PWSH_AI_COST"
          } >> "$GITHUB_OUTPUT"

          # Save full outputs for summary
          {
            echo "pwsh_cost_details<<EOF"
            echo "$PWSH_COST_OUTPUT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "ace_cost_details<<EOF"
            echo "$ACE_COST_OUTPUT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          # Generate summary
          {
            echo "## üí∞ Pre-Deployment Cost Estimation"
            echo ""
            echo "**Environment:** ${{ github.event.inputs.environment }}"
            echo "**SKU:** ${{ github.event.inputs.sku }}"
            echo "**Region:** $LOCATION"
            echo ""
            echo "### Primary Estimate (PowerShell): \`\$$PWSH_TOTAL_COST USD/month\`"
            echo ""
            echo "| Resource | Monthly Cost |"
            echo "|----------|--------------|"
            echo "| Function App Plan (${{ github.event.inputs.sku }}) | \`\$$PWSH_FUNCTION_COST\` |"
            echo "| Storage Account (Standard LRS) | \`\$$PWSH_STORAGE_COST\` |"
            echo "| Application Insights | \`\$$PWSH_AI_COST\` |"
            echo "| **Total** | **\`\$$PWSH_TOTAL_COST\`** |"
            echo ""
            echo "### Secondary Estimate (ACE): \`\$$ACE_TOTAL_COST USD/month\`"
            echo ""

            # Show discrepancy warning if estimates differ significantly
            if [ "$PWSH_TOTAL_COST" != "N/A" ] && [ "$ACE_TOTAL_COST" != "Unable to calculate" ] && [ "$ACE_TOTAL_COST" != "N/A" ]; then
              # Remove any dollar signs for comparison
              PWSH_NUM=$(echo "$PWSH_TOTAL_COST" | tr -d '$')
              ACE_NUM=$(echo "$ACE_TOTAL_COST" | tr -d '$')

              # Check if difference is > 10%
              DIFF=$(echo "scale=2; ($PWSH_NUM - $ACE_NUM) / $PWSH_NUM * 100" | bc -l 2>/dev/null || echo "0")
              ABS_DIFF=$(echo "$DIFF" | tr -d '-')

              if (( $(echo "$ABS_DIFF > 10" | bc -l 2>/dev/null || echo 0) )); then
                echo "> **‚ö†Ô∏è  Note:** Significant difference detected between estimators (${ABS_DIFF}% variance)."
                echo "> The PowerShell estimator uses official Azure pricing and is more accurate."
                echo ""
              fi
            fi

            echo "<details>"
            echo "<summary>View PowerShell detailed cost breakdown</summary>"
            echo ""
            echo "\`\`\`"
            echo "$PWSH_COST_OUTPUT"
            echo "\`\`\`"
            echo ""
            echo "</details>"
            echo ""
            echo "<details>"
            echo "<summary>View ACE cost breakdown (reference)</summary>"
            echo ""
            echo "\`\`\`"
            echo "$ACE_COST_OUTPUT"
            echo "\`\`\`"
            echo ""
            echo "</details>"
            echo ""
            echo "---"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Deploy Bicep template
        id: deploy
        shell: bash {0}  # {0} removes default -e -o pipefail, giving us full control
        run: |
          set -e  # Enable exit on error, but we'll control it ourselves
          source /tmp/retry-utils.sh

          echo "üöÄ Deploying infrastructure to ${{ github.event.inputs.environment }} environment..."

          DEPLOYMENT_NAME="infrastructure-deploy-$(date +%Y%m%d-%H%M%S)"
          MANAGED_IDENTITY_RESOURCE_ID="${{ steps.get_identity.outputs.managed_identity_resource_id }}"

          echo "Using managed identity: $MANAGED_IDENTITY_RESOURCE_ID"

          # Deploy with retry logic
          # Note: We don't capture deployment output here because Bicep warnings corrupt JSON
          # Instead, we query the deployment separately after it completes
          # Disable exit-on-error to capture the deployment exit code for custom handling
          set +e
          retry_azure_operation \
            "$MAX_RETRY_ATTEMPTS" \
            "Deploy Bicep template" \
            az deployment group create \
              --name "$DEPLOYMENT_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --template-file infrastructure/main.bicep \
              --parameters infrastructure/main.bicepparam \
              --parameters environment=${{ github.event.inputs.environment }} \
              --parameters functionAppPlanSku=${{ github.event.inputs.sku }} \
              --parameters managedIdentityResourceId="$MANAGED_IDENTITY_RESOURCE_ID" \
              --output none
          DEPLOYMENT_EXIT_CODE=$?

          # Generate policy report regardless of deployment success/failure
          echo ""
          echo "üìã Generating Azure Policy compliance report..."
          source /tmp/policy-query.sh
          POLICY_REPORT=$(generate_policy_report "$RESOURCE_GROUP" 2>&1) || {
            POLICY_REPORT="‚ö†Ô∏è Unable to generate policy compliance report. Check logs for details."
          }

          # Check if deployment succeeded
          if [ $DEPLOYMENT_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Deployment failed with exit code $DEPLOYMENT_EXIT_CODE"
            echo ""
            echo "üìÑ Writing failure summary to GitHub Actions..."

            # Add failure summary with policy report
            {
              echo "## ‚ùå Deployment Failed"
              echo ""
              echo "**Environment:** ${{ github.event.inputs.environment }}"
              echo "**SKU:** ${{ github.event.inputs.sku }}"
              echo "**Resource Group:** $RESOURCE_GROUP"
              echo ""
              echo "### Possible Causes"
              echo ""
              echo "1. **Azure Policy Denial** - A policy may be blocking this deployment"
              echo "2. **Resource Quota Exceeded** - Check subscription limits"
              echo "3. **Invalid Parameters** - Review Bicep parameter values"
              echo "4. **Permission Issues** - Verify RBAC permissions"
              echo ""
              echo "### Policy Compliance Status"
              echo ""
              echo "$POLICY_REPORT"
              echo ""
              echo "---"
              echo ""
              echo "Review the deployment logs above for detailed error messages."
            } >> "$GITHUB_STEP_SUMMARY"

            echo "‚úÖ Failure summary written to GitHub Actions"
            echo ""
            echo "Exiting with code $DEPLOYMENT_EXIT_CODE"

            # Exit with failure code (set -e still disabled, so we control the exit)
            exit $DEPLOYMENT_EXIT_CODE
          fi

          # Re-enable exit on error for successful deployments
          set -e

          echo "‚úÖ Deployment completed successfully!"

          # Query the deployment to get clean JSON output (no Bicep warnings)
          echo "üìã Retrieving deployment outputs..."
          deployment_output=$(az deployment group show \
            --name "$DEPLOYMENT_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --output json)

          # Validate JSON output
          if ! echo "$deployment_output" | jq empty 2>/dev/null; then
            echo "‚ùå Error: Failed to retrieve valid deployment output"
            echo "Deployment output:"
            echo "$deployment_output"
            exit 1
          fi

          # Extract outputs from deployment
          function_app_name=$(echo "$deployment_output" | jq -r '.properties.outputs.functionAppName.value')
          storage_account_name=$(echo "$deployment_output" | jq -r '.properties.outputs.storageAccountName.value')
          app_insights_name=$(echo "$deployment_output" | jq -r '.properties.outputs.appInsightsName.value')

          # Set outputs for next steps
          {
            echo "function_app_name=$function_app_name"
            echo "storage_account_name=$storage_account_name"
            echo "app_insights_name=$app_insights_name"
          } >> "$GITHUB_OUTPUT"

          # Display deployment summary
          SKU_TYPE="Consumption"
          if [ "${{ github.event.inputs.sku }}" = "EP1" ]; then
            SKU_TYPE="Elastic Premium"
          fi

          {
            echo "### Deployment Summary"
            echo ""
            echo "**Environment:** ${{ github.event.inputs.environment }}"
            echo "**SKU:** ${{ github.event.inputs.sku }} ($SKU_TYPE)"
            echo "**Resource Group:** $RESOURCE_GROUP"
            echo "**Location:** $LOCATION"
            echo ""
            echo "#### Deployed Resources"
            echo "- **Function App:** $function_app_name"
            echo "- **Storage Account:** $storage_account_name"
            echo "- **Application Insights:** $app_insights_name"
            echo ""
            echo "**Function App URL:** https://$function_app_name.azurewebsites.net"
            echo ""
            echo "$POLICY_REPORT"
            echo ""
            echo "#### Retry Configuration"
            echo "- Max retry attempts: $MAX_RETRY_ATTEMPTS"
            echo "- Base retry delay: ${RETRY_BASE_DELAY}s"
            echo "- Backoff strategy: Exponential (2x, max 32s)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Verify deployment
        id: verify
        shell: bash
        run: |
          source /tmp/retry-utils.sh
          source /tmp/deployment-verification.sh

          echo "üîç Verifying deployed resources..."
          echo ""

          # List deployed resources
          retry_azure_operation \
            3 \
            "List deployed resources" \
            az resource list \
              --resource-group "$RESOURCE_GROUP" \
              --output table

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""

          # Run comprehensive deployment verification
          FUNCTION_APP_NAME="${{ steps.deploy.outputs.function_app_name }}"
          STORAGE_ACCOUNT_NAME="${{ steps.deploy.outputs.storage_account_name }}"
          APP_INSIGHTS_NAME="${{ steps.deploy.outputs.app_insights_name }}"
          FUNCTION_URL="https://$FUNCTION_APP_NAME.azurewebsites.net"

          if verify_deployment \
            "$FUNCTION_APP_NAME" \
            "$STORAGE_ACCOUNT_NAME" \
            "$APP_INSIGHTS_NAME" \
            "$RESOURCE_GROUP" \
            "$FUNCTION_URL"; then
            echo "verification_status=‚úÖ Passed" >> "$GITHUB_OUTPUT"
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚úÖ Deployment verification completed successfully!"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Add verification results to summary
            {
              echo ""
              echo "## ‚úÖ Deployment Verification"
              echo ""
              echo "All post-deployment checks passed:"
              echo ""
              echo "- ‚úÖ Function App is running"
              echo "- ‚úÖ Storage account accessible"
              echo "- ‚úÖ Application Insights configured"
              echo "- ‚úÖ Health endpoint responsive"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "verification_status=‚ö†Ô∏è Failed" >> "$GITHUB_OUTPUT"
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚ö†Ô∏è  Some deployment verification checks failed"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Add warning to summary
            {
              echo ""
              echo "## ‚ö†Ô∏è Deployment Verification"
              echo ""
              echo "Some post-deployment checks failed. Review the logs above for details."
            } >> "$GITHUB_STEP_SUMMARY"

            # Don't fail the workflow - resources are deployed but may need attention
            exit 0
          fi

      - name: Update shared Key Vault secret
        shell: bash
        run: |
          source /tmp/retry-utils.sh
          source /tmp/keyvault-utils.sh

          echo "üîë Updating shared Key Vault secret..."
          echo ""

          # Get the Function App name from deployment output
          FUNCTION_APP_NAME="${{ steps.deploy.outputs.function_app_name }}"

          if [ -z "$FUNCTION_APP_NAME" ]; then
            echo "‚ùå Failed to get Function App name from deployment output"
            exit 1
          fi

          # Get the Function App URL
          FUNCTION_APP_URL=$(az functionapp show \
            --name "$FUNCTION_APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query defaultHostName -o tsv)

          if [ -z "$FUNCTION_APP_URL" ]; then
            echo "‚ùå Failed to get Function App URL"
            exit 1
          fi

          echo "Function App: $FUNCTION_APP_NAME"
          echo "URL: https://$FUNCTION_APP_URL"
          echo ""

          # Update Key Vault secret in shared resource group with verification
          SHARED_KEY_VAULT="kv-tsazurehealth"
          SECRET_NAME="function-app-url-${{ inputs.environment }}"
          SECRET_VALUE="https://$FUNCTION_APP_URL"

          if update_and_verify_keyvault_secret "$SHARED_KEY_VAULT" "$SECRET_NAME" "$SECRET_VALUE"; then
            echo ""
            echo "‚úÖ Key Vault secret update complete and verified"
          else
            echo ""
            echo "‚ùå Key Vault secret update or verification failed"
            exit 1
          fi

          # Add to summary
          {
            echo "## üîë Shared Configuration"
            echo ""
            echo "Key Vault secret updated successfully:"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| Key Vault | \`$SHARED_KEY_VAULT\` |"
            echo "| Secret Name | \`$SECRET_NAME\` |"
            echo "| Function App | \`$FUNCTION_APP_NAME\` |"
            echo "| URL | \`https://$FUNCTION_APP_URL\` |"
            echo ""
            echo "‚úÖ Secret verified in Key Vault"
            echo ""
            echo "Frontend applications can now access this URL using their managed identity."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Analyze actual deployment costs (Post-Deploy)
        id: cost_actual
        shell: bash
        run: |
          echo "üí∞ Analyzing actual deployment costs with azure-cost-cli..."
          echo ""

          # Note: azure-cost-cli shows costs from the last billing period
          # For newly deployed resources, costs may not be available immediately
          echo "‚è≥ Querying Azure Cost Management API for resource group costs..."
          echo "Note: Newly deployed resources may take 8-24 hours to appear in cost data"
          echo ""

          # Verify azure-cost is available
          if ! command -v azure-cost &> /dev/null; then
            echo "‚ùå azure-cost not found in PATH"
            echo "PATH: $PATH"
            ls -la "$HOME/.dotnet/tools/" 2>/dev/null || echo "dotnet tools directory not found"
            ACTUAL_COST="Tool not available"
            COST_STATUS="‚ùå azure-cost-cli not installed"
          else
            echo "‚úÖ Found azure-cost: $(which azure-cost)"

            # Get costs for the resource group (month to date)
            ACTUAL_COST_OUTPUT=$(azure-cost \
              --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }} \
              --resource-group "$RESOURCE_GROUP" \
              --output json \
              --timeframe "MonthToDate" 2>&1 || true)

            echo "Raw output:"
            echo "$ACTUAL_COST_OUTPUT"
            echo ""

            # Try to extract cost from JSON output
            ACTUAL_COST="N/A"
            if echo "$ACTUAL_COST_OUTPUT" | jq -e . >/dev/null 2>&1; then
              # Valid JSON, try to extract cost
              ACTUAL_COST=$(echo "$ACTUAL_COST_OUTPUT" | jq -r '.totalCost // .Total // "N/A"' 2>/dev/null || echo "N/A")
            fi

            # If we couldn't get costs, explain why
            if [ "$ACTUAL_COST" = "N/A" ] || [ "$ACTUAL_COST" = "null" ]; then
              echo "‚ö†Ô∏è  Actual cost data not yet available (resources were just deployed)"
              ACTUAL_COST="Not yet available"
              COST_STATUS="‚è≥ Pending (check in 24 hours)"
            else
              echo "üíµ Actual cost (month-to-date): \$$ACTUAL_COST"
              COST_STATUS="‚úÖ Available"
            fi
          fi

          # Save for summary
          {
            echo "actual_cost=$ACTUAL_COST"
            echo "cost_status=$COST_STATUS"
          } >> "$GITHUB_OUTPUT"

          # Save full output for summary
          {
            echo "actual_cost_details<<EOF"
            echo "$ACTUAL_COST_OUTPUT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "## üíµ Post-Deployment Cost Analysis"
            echo ""
            echo "**Resource Group:** \`$RESOURCE_GROUP\`"
            echo "**Time Period:** Month to Date"
            echo "**Status:** $COST_STATUS"
            echo ""
            echo "### Actual Cost: \`\$$ACTUAL_COST\`"
            echo ""
            if [ "$ACTUAL_COST" != "Not yet available" ] && [ "$ACTUAL_COST" != "N/A" ]; then
              echo "<details>"
              echo "<summary>View detailed cost breakdown</summary>"
              echo ""
              echo "\`\`\`"
              echo "$ACTUAL_COST_OUTPUT"
              echo "\`\`\`"
              echo ""
              echo "</details>"
            else
              echo "> **Note:** Cost data for newly deployed resources typically becomes available within 8-24 hours."
              echo "> You can check actual costs later using:"
              echo "> \`\`\`bash"
              echo "> az costmanagement query \\"
              echo ">   --type ActualCost \\"
              echo ">   --dataset-filter \"{\\\"and\\\":[{\\\"dimensions\\\":{\\\"name\\\":\\\"ResourceGroup\\\",\\\"operator\\\":\\\"In\\\",\\\"values\\\":[\\\"$RESOURCE_GROUP\\\"]}}]}\" \\"
              echo ">   --timeframe MonthToDate"
              echo "> \`\`\`"
            fi
            echo ""
            echo "---"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Generate cost comparison summary
        shell: bash
        run: |
          echo "üìä Generating cost comparison summary..."

          PWSH_COST="${{ steps.cost_estimate.outputs.pwsh_total_cost }}"
          ACE_COST="${{ steps.cost_estimate.outputs.ace_total_cost }}"
          ACTUAL_COST="${{ steps.cost_actual.outputs.actual_cost }}"

          {
            echo ""
            echo "# üí∞ Azure Cost Report Summary"
            echo ""
            echo "## Cost Overview"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| **Pre-Deployment Estimate (Primary)** | \`$PWSH_COST\` |"
            echo "| **Pre-Deployment Estimate (ACE)** | \`$ACE_COST\` |"
            echo "| **Post-Deployment Actual** | \`$ACTUAL_COST\` |"
            echo "| **Environment** | \`${{ github.event.inputs.environment }}\` |"
            echo "| **SKU** | \`${{ github.event.inputs.sku }}\` |"
            echo "| **Resource Group** | \`$RESOURCE_GROUP\` |"
            echo ""

            if [ "$ACTUAL_COST" != "Not yet available" ] && [ "$ACTUAL_COST" != "N/A" ]; then
              echo "## üìà Cost Comparison"
              echo ""
              echo "‚úÖ Both estimated and actual costs are available for comparison."
              echo ""
              echo "> **Note:** Actual costs represent month-to-date spending for the resource group."
              echo "> The estimate is a projected monthly cost based on the Bicep template configuration."
            else
              echo "## ‚è≥ Cost Comparison"
              echo ""
              echo "Actual cost data is not yet available. Azure Cost Management typically requires 8-24 hours to process new resource costs."
              echo ""
              echo "### Follow-up Actions"
              echo ""
              echo "1. **Check costs in 24 hours:**"
              echo "   \`\`\`bash"
              echo "   az costmanagement query --type ActualCost \\"
              echo "     --dataset-filter \"{\\\"and\\\":[{\\\"dimensions\\\":{\\\"name\\\":\\\"ResourceGroup\\\",\\\"operator\\\":\\\"In\\\",\\\"values\\\":[\\\"$RESOURCE_GROUP\\\"]}}]}\" \\"
              echo "     --timeframe MonthToDate"
              echo "   \`\`\`"
              echo ""
              echo "2. **Set up cost alerts** in Azure Portal ‚Üí Cost Management + Billing ‚Üí Cost alerts"
              echo ""
              echo "3. **Review Azure Advisor** recommendations for cost optimization"
              echo ""
              echo "4. **Run local cost estimation:**"
              echo "   \`\`\`bash"
              echo "   pwsh ./scripts/infrastructure/estimate-costs.ps1 -Sku ${{ github.event.inputs.sku }} -Environment ${{ github.event.inputs.environment }}"
              echo "   \`\`\`"
            fi

            echo ""
            echo "## üìã Deployment Details"
            echo ""
            echo "- **Function App:** \`${{ steps.deploy.outputs.function_app_name }}\`"
            echo "- **Storage Account:** \`${{ steps.deploy.outputs.storage_account_name }}\`"
            echo "- **App Insights:** \`${{ steps.deploy.outputs.app_insights_name }}\`"
            echo "- **Deployment Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "## üîó Useful Links"
            echo ""
            echo "- [Azure Cost Management](https://portal.azure.com/#view/Microsoft_Azure_CostManagement/Menu/~/overview)"
            echo "- [Resource Group: $RESOURCE_GROUP](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$RESOURCE_GROUP/overview)"
            echo "- [Azure Advisor](https://portal.azure.com/#view/Microsoft_Azure_Expert/AdvisorMenuBlade/~/Cost)"
            echo ""
            echo "---"
            echo ""
            echo "*Primary cost estimation: PowerShell script with Azure pricing data*"
            echo ""
            echo "*Secondary cost estimation: [ACE (Azure Cost Estimator)](https://github.com/TheCloudTheory/arm-estimator)*"
            echo ""
            echo "*Actual cost analysis: [azure-cost-cli](https://github.com/mivano/azure-cost-cli)*"
          } >> "$GITHUB_STEP_SUMMARY"

          echo "‚úÖ Cost comparison summary generated"
