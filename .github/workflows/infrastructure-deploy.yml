name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: 'dev'
      sku:
        description: 'Function App hosting plan SKU'
        required: true
        type: choice
        options:
          - Y1
          - EP1
        default: 'Y1'

permissions:
  contents: read
  id-token: write

env:
  MAX_RETRY_ATTEMPTS: 5
  RETRY_BASE_DELAY: 2

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set environment variables
        run: |
          echo "RESOURCE_GROUP=rg-azure-health-${{ github.event.inputs.environment }}" >> "$GITHUB_ENV"
          echo "LOCATION=eastus" >> "$GITHUB_ENV"

      - name: Setup CI utilities
        shell: bash
        run: |
          # Download retry utilities from shared repo
          curl -sSL https://raw.githubusercontent.com/stuartshay/shared-azure-health/master/scripts/retry-utils.sh -o /tmp/retry-utils.sh
          chmod +x /tmp/retry-utils.sh
          echo "âœ… Retry utilities configured (shared version)"

          # Copy policy query utilities from source
          cp scripts/ci/policy-query.sh /tmp/policy-query.sh
          chmod +x /tmp/policy-query.sh
          echo "âœ… Policy query utilities configured"

          # Download Key Vault utilities from shared repository
          curl -sSL https://raw.githubusercontent.com/stuartshay/shared-azure-health/master/scripts/keyvault-utils.sh -o /tmp/keyvault-utils.sh
          chmod +x /tmp/keyvault-utils.sh
          echo "âœ… Key Vault utilities configured (shared version)"

          # Copy deployment verification utilities from source
          cp scripts/ci/deployment-verification.sh /tmp/deployment-verification.sh
          chmod +x /tmp/deployment-verification.sh
          echo "âœ… Deployment verification utilities configured"

      - name: Install cost estimation tools
        shell: bash
        run: |
          ./scripts/ci/install-cost-tools.sh

      - name: Create resource group if not exists
        shell: bash
        run: |
          source /tmp/retry-utils.sh

          # Check if resource group exists (use az group show instead of exists for reliability)
          if az group show --name "$RESOURCE_GROUP" > /dev/null 2>&1; then
            echo "âœ… Resource group already exists: $RESOURCE_GROUP"
            exit 0
          fi

          # Create resource group with retry logic
          echo "ðŸ“¦ Creating resource group: $RESOURCE_GROUP"
          retry_azure_operation \
            "$MAX_RETRY_ATTEMPTS" \
            "Create resource group $RESOURCE_GROUP" \
            az group create \
              --name "$RESOURCE_GROUP" \
              --location "$LOCATION" \
              --tags environment=${{ github.event.inputs.environment }} project=azure-health \
              --output none

          # Verify resource group was created
          echo "ðŸ” Verifying resource group creation..."
          if ! az group show --name "$RESOURCE_GROUP" > /dev/null 2>&1; then
            echo "âŒ Resource group verification failed: $RESOURCE_GROUP was not created"
            exit 1
          fi
          echo "âœ… Resource group verified: $RESOURCE_GROUP"

      - name: Get managed identity from shared infrastructure
        id: get_identity
        shell: bash
        run: |
          echo "ðŸ” Retrieving managed identity from shared infrastructure..."

          # Query Azure for the shared managed identity
          SHARED_RG="rg-azure-health-shared"
          IDENTITY_NAME="id-azurehealth-shared"

          # Check if shared resource group exists
          if ! az group show --name "$SHARED_RG" --output none 2>/dev/null; then
            echo "âŒ Error: Shared resource group '$SHARED_RG' not found"
            echo ""
            echo "The shared infrastructure has not been set up. Please run:"
            echo "  ./scripts/infrastructure/setup-shared-identity.ps1"
            echo ""
            echo "This will create the shared resource group and managed identity."
            exit 1
          fi

          # Get managed identity resource ID
          MANAGED_IDENTITY_RESOURCE_ID=$(az identity show \
            --name "$IDENTITY_NAME" \
            --resource-group "$SHARED_RG" \
            --query id \
            --output tsv 2>/dev/null)

          if [ -z "$MANAGED_IDENTITY_RESOURCE_ID" ] || [ "$MANAGED_IDENTITY_RESOURCE_ID" == "null" ]; then
            echo "âŒ Error: Managed identity '$IDENTITY_NAME' not found in resource group '$SHARED_RG'"
            echo ""
            echo "Please run: ./scripts/infrastructure/setup-shared-identity.ps1"
            exit 1
          fi

          echo "âœ… Found managed identity: $MANAGED_IDENTITY_RESOURCE_ID"
          echo "managed_identity_resource_id=$MANAGED_IDENTITY_RESOURCE_ID" >> "$GITHUB_OUTPUT"

      - name: Estimate deployment costs (Pre-Deploy)
        id: cost_estimate
        shell: bash
        run: |
          ./scripts/ci/cost-estimate.sh \
            --environment "${{ github.event.inputs.environment }}" \
            --sku "${{ github.event.inputs.sku }}" \
            --location "$LOCATION" \
            --subscription-id "${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            --resource-group "$RESOURCE_GROUP" \
            --managed-identity-id "${{ steps.get_identity.outputs.managed_identity_resource_id }}" \
            --summary-path "$GITHUB_STEP_SUMMARY"
      - name: Deploy Bicep template
        id: deploy
        shell: bash {0}  # {0} removes default -e -o pipefail, giving us full control
        run: |
          set -e  # Enable exit on error, but we'll control it ourselves
          source /tmp/retry-utils.sh

          echo "ðŸš€ Deploying infrastructure to ${{ github.event.inputs.environment }} environment..."

          DEPLOYMENT_NAME="infrastructure-deploy-$(date +%Y%m%d-%H%M%S)"
          MANAGED_IDENTITY_RESOURCE_ID="${{ steps.get_identity.outputs.managed_identity_resource_id }}"

          echo "Using managed identity: $MANAGED_IDENTITY_RESOURCE_ID"

          # Deploy with retry logic
          # Note: We don't capture deployment output here because Bicep warnings corrupt JSON
          # Instead, we query the deployment separately after it completes
          # Disable exit-on-error to capture the deployment exit code for custom handling
          set +e
          retry_azure_operation \
            "$MAX_RETRY_ATTEMPTS" \
            "Deploy Bicep template" \
            az deployment group create \
              --name "$DEPLOYMENT_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --template-file infrastructure/main.bicep \
              --parameters infrastructure/main.bicepparam \
              --parameters environment=${{ github.event.inputs.environment }} \
              --parameters functionAppPlanSku=${{ github.event.inputs.sku }} \
              --parameters managedIdentityResourceId="$MANAGED_IDENTITY_RESOURCE_ID" \
              --output none
          DEPLOYMENT_EXIT_CODE=$?

          # Generate policy report regardless of deployment success/failure
          echo ""
          echo "ðŸ“‹ Generating Azure Policy compliance report..."
          source /tmp/policy-query.sh
          POLICY_REPORT=$(generate_policy_report "$RESOURCE_GROUP" 2>&1) || {
            POLICY_REPORT="âš ï¸ Unable to generate policy compliance report. Check logs for details."
          }

          # Check if deployment succeeded
          if [ $DEPLOYMENT_EXIT_CODE -ne 0 ]; then
            echo "âŒ Deployment failed with exit code $DEPLOYMENT_EXIT_CODE"
            echo ""
            echo "ðŸ“„ Writing failure summary to GitHub Actions..."

            # Add failure summary with policy report
            {
              echo "## âŒ Deployment Failed"
              echo ""
              echo "**Environment:** ${{ github.event.inputs.environment }}"
              echo "**SKU:** ${{ github.event.inputs.sku }}"
              echo "**Resource Group:** $RESOURCE_GROUP"
              echo ""
              echo "### Possible Causes"
              echo ""
              echo "1. **Azure Policy Denial** - A policy may be blocking this deployment"
              echo "2. **Resource Quota Exceeded** - Check subscription limits"
              echo "3. **Invalid Parameters** - Review Bicep parameter values"
              echo "4. **Permission Issues** - Verify RBAC permissions"
              echo ""
              echo "### Policy Compliance Status"
              echo ""
              echo "$POLICY_REPORT"
              echo ""
              echo "---"
              echo ""
              echo "Review the deployment logs above for detailed error messages."
            } >> "$GITHUB_STEP_SUMMARY"

            echo "âœ… Failure summary written to GitHub Actions"
            echo ""
            echo "Exiting with code $DEPLOYMENT_EXIT_CODE"

            # Exit with failure code (set -e still disabled, so we control the exit)
            exit $DEPLOYMENT_EXIT_CODE
          fi

          # Re-enable exit on error for successful deployments
          set -e

          echo "âœ… Deployment completed successfully!"

          # Query the deployment to get clean JSON output (no Bicep warnings)
          echo "ðŸ“‹ Retrieving deployment outputs..."
          deployment_output=$(az deployment group show \
            --name "$DEPLOYMENT_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --output json)

          # Validate JSON output
          if ! echo "$deployment_output" | jq empty 2>/dev/null; then
            echo "âŒ Error: Failed to retrieve valid deployment output"
            echo "Deployment output:"
            echo "$deployment_output"
            exit 1
          fi

          # Extract outputs from deployment
          function_app_name=$(echo "$deployment_output" | jq -r '.properties.outputs.functionAppName.value')
          storage_account_name=$(echo "$deployment_output" | jq -r '.properties.outputs.storageAccountName.value')
          app_insights_name=$(echo "$deployment_output" | jq -r '.properties.outputs.appInsightsName.value')

          # Set outputs for next steps
          {
            echo "function_app_name=$function_app_name"
            echo "storage_account_name=$storage_account_name"
            echo "app_insights_name=$app_insights_name"
          } >> "$GITHUB_OUTPUT"

          # Display deployment summary
          SKU_TYPE="Consumption"
          if [ "${{ github.event.inputs.sku }}" = "EP1" ]; then
            SKU_TYPE="Elastic Premium"
          fi

          {
            echo "### Deployment Summary"
            echo ""
            echo "**Environment:** ${{ github.event.inputs.environment }}"
            echo "**SKU:** ${{ github.event.inputs.sku }} ($SKU_TYPE)"
            echo "**Resource Group:** $RESOURCE_GROUP"
            echo "**Location:** $LOCATION"
            echo ""
            echo "#### Deployed Resources"
            echo "- **Function App:** $function_app_name"
            echo "- **Storage Account:** $storage_account_name"
            echo "- **Application Insights:** $app_insights_name"
            echo ""
            echo "**Function App URL:** https://$function_app_name.azurewebsites.net"
            echo ""
            echo "$POLICY_REPORT"
            echo ""
            echo "#### Retry Configuration"
            echo "- Max retry attempts: $MAX_RETRY_ATTEMPTS"
            echo "- Base retry delay: ${RETRY_BASE_DELAY}s"
            echo "- Backoff strategy: Exponential (2x, max 32s)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Verify deployment
        id: verify
        shell: bash
        run: |
          source /tmp/retry-utils.sh
          source /tmp/deployment-verification.sh

          echo "ðŸ” Verifying deployed resources..."
          echo ""

          # List deployed resources
          retry_azure_operation \
            3 \
            "List deployed resources" \
            az resource list \
              --resource-group "$RESOURCE_GROUP" \
              --output table

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Run comprehensive deployment verification
          FUNCTION_APP_NAME="${{ steps.deploy.outputs.function_app_name }}"
          STORAGE_ACCOUNT_NAME="${{ steps.deploy.outputs.storage_account_name }}"
          APP_INSIGHTS_NAME="${{ steps.deploy.outputs.app_insights_name }}"
          FUNCTION_URL="https://$FUNCTION_APP_NAME.azurewebsites.net"

          if verify_deployment \
            "$FUNCTION_APP_NAME" \
            "$STORAGE_ACCOUNT_NAME" \
            "$APP_INSIGHTS_NAME" \
            "$RESOURCE_GROUP" \
            "$FUNCTION_URL"; then
            echo "verification_status=âœ… Passed" >> "$GITHUB_OUTPUT"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment verification completed successfully!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Add verification results to summary
            {
              echo ""
              echo "## âœ… Deployment Verification"
              echo ""
              echo "All post-deployment checks passed:"
              echo ""
              echo "- âœ… Function App is running"
              echo "- âœ… Storage account accessible"
              echo "- âœ… Application Insights configured"
              echo "- âœ… Health endpoint responsive"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "verification_status=âš ï¸ Failed" >> "$GITHUB_OUTPUT"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âš ï¸  Some deployment verification checks failed"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Add warning to summary
            {
              echo ""
              echo "## âš ï¸ Deployment Verification"
              echo ""
              echo "Some post-deployment checks failed. Review the logs above for details."
            } >> "$GITHUB_STEP_SUMMARY"

            # Don't fail the workflow - resources are deployed but may need attention
            exit 0
          fi

      - name: Update shared Key Vault secret
        shell: bash
        run: |
          source /tmp/retry-utils.sh
          source /tmp/keyvault-utils.sh

          echo "ðŸ”‘ Updating shared Key Vault secret..."
          echo ""

          # Get the Function App name from deployment output
          FUNCTION_APP_NAME="${{ steps.deploy.outputs.function_app_name }}"

          if [ -z "$FUNCTION_APP_NAME" ]; then
            echo "âŒ Failed to get Function App name from deployment output"
            exit 1
          fi

          # Get the Function App URL
          FUNCTION_APP_URL=$(az functionapp show \
            --name "$FUNCTION_APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query defaultHostName -o tsv)

          if [ -z "$FUNCTION_APP_URL" ]; then
            echo "âŒ Failed to get Function App URL"
            exit 1
          fi

          echo "Function App: $FUNCTION_APP_NAME"
          echo "URL: https://$FUNCTION_APP_URL"
          echo ""

          # Update Key Vault secret in shared resource group with verification
          SHARED_KEY_VAULT="kv-tsazurehealth"
          SECRET_NAME="function-app-url-${{ inputs.environment }}"
          SECRET_VALUE="https://$FUNCTION_APP_URL"

          if update_and_verify_keyvault_secret "$SHARED_KEY_VAULT" "$SECRET_NAME" "$SECRET_VALUE"; then
            echo ""
            echo "âœ… Key Vault secret update complete and verified"
          else
            echo ""
            echo "âŒ Key Vault secret update or verification failed"
            exit 1
          fi

          # Add to summary
          {
            echo "## ðŸ”‘ Shared Configuration"
            echo ""
            echo "Key Vault secret updated successfully:"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| Key Vault | \`$SHARED_KEY_VAULT\` |"
            echo "| Secret Name | \`$SECRET_NAME\` |"
            echo "| Function App | \`$FUNCTION_APP_NAME\` |"
            echo "| URL | \`https://$FUNCTION_APP_URL\` |"
            echo ""
            echo "âœ… Secret verified in Key Vault"
            echo ""
            echo "Frontend applications can now access this URL using their managed identity."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Analyze actual deployment costs (Post-Deploy)
        id: cost_actual
        shell: bash
        run: |
          ./scripts/ci/cost-analysis.sh \
            --resource-group "$RESOURCE_GROUP" \
            --subscription-id "${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            --summary-path "$GITHUB_STEP_SUMMARY"
      - name: Generate cost comparison summary
        shell: bash
        run: |
          echo "ðŸ“Š Generating cost comparison summary..."

          PWSH_COST="${{ steps.cost_estimate.outputs.pwsh_total_cost }}"
          ACE_COST="${{ steps.cost_estimate.outputs.ace_total_cost }}"
          ACTUAL_COST="${{ steps.cost_actual.outputs.actual_cost }}"

          {
            echo ""
            echo "# ðŸ’° Azure Cost Report Summary"
            echo ""
            echo "## Cost Overview"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| **Pre-Deployment Estimate (Primary)** | \`$PWSH_COST\` |"
            echo "| **Pre-Deployment Estimate (ACE)** | \`$ACE_COST\` |"
            echo "| **Post-Deployment Actual** | \`$ACTUAL_COST\` |"
            echo "| **Environment** | \`${{ github.event.inputs.environment }}\` |"
            echo "| **SKU** | \`${{ github.event.inputs.sku }}\` |"
            echo "| **Resource Group** | \`$RESOURCE_GROUP\` |"
            echo ""

            if [ "$ACTUAL_COST" != "Not yet available" ] && [ "$ACTUAL_COST" != "N/A" ]; then
              echo "## ðŸ“ˆ Cost Comparison"
              echo ""
              echo "âœ… Both estimated and actual costs are available for comparison."
              echo ""
              echo "> **Note:** Actual costs represent month-to-date spending for the resource group."
              echo "> The estimate is a projected monthly cost based on the Bicep template configuration."
            else
              echo "## â³ Cost Comparison"
              echo ""
              echo "Actual cost data is not yet available. Azure Cost Management typically requires 8-24 hours to process new resource costs."
              echo ""
              echo "### Follow-up Actions"
              echo ""
              echo "1. **Check costs in 24 hours:**"
              echo "   \`\`\`bash"
              echo "   az costmanagement query --type ActualCost \\"
              echo "     --dataset-filter \"{\\\"and\\\":[{\\\"dimensions\\\":{\\\"name\\\":\\\"ResourceGroup\\\",\\\"operator\\\":\\\"In\\\",\\\"values\\\":[\\\"$RESOURCE_GROUP\\\"]}}]}\" \\"
              echo "     --timeframe MonthToDate"
              echo "   \`\`\`"
              echo ""
              echo "2. **Set up cost alerts** in Azure Portal â†’ Cost Management + Billing â†’ Cost alerts"
              echo ""
              echo "3. **Review Azure Advisor** recommendations for cost optimization"
              echo ""
              echo "4. **Run local cost estimation:**"
              echo "   \`\`\`bash"
              echo "   pwsh ./scripts/infrastructure/estimate-costs.ps1 -Sku ${{ github.event.inputs.sku }} -Environment ${{ github.event.inputs.environment }}"
              echo "   \`\`\`"
            fi

            echo ""
            echo "## ðŸ“‹ Deployment Details"
            echo ""
            echo "- **Function App:** \`${{ steps.deploy.outputs.function_app_name }}\`"
            echo "- **Storage Account:** \`${{ steps.deploy.outputs.storage_account_name }}\`"
            echo "- **App Insights:** \`${{ steps.deploy.outputs.app_insights_name }}\`"
            echo "- **Deployment Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "## ðŸ”— Useful Links"
            echo ""
            echo "- [Azure Cost Management](https://portal.azure.com/#view/Microsoft_Azure_CostManagement/Menu/~/overview)"
            echo "- [Resource Group: $RESOURCE_GROUP](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$RESOURCE_GROUP/overview)"
            echo "- [Azure Advisor](https://portal.azure.com/#view/Microsoft_Azure_Expert/AdvisorMenuBlade/~/Cost)"
            echo ""
            echo "---"
            echo ""
            echo "*Primary cost estimation: PowerShell script with Azure pricing data*"
            echo ""
            echo "*Secondary cost estimation: [ACE (Azure Cost Estimator)](https://github.com/TheCloudTheory/arm-estimator)*"
            echo ""
            echo "*Actual cost analysis: [azure-cost-cli](https://github.com/mivano/azure-cost-cli)*"
          } >> "$GITHUB_STEP_SUMMARY"

          echo "âœ… Cost comparison summary generated"
