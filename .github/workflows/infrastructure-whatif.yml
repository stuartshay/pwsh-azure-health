name: Infrastructure What-If

on:
  pull_request:
    branches:
      - master
      - develop
    paths:
      - 'infrastructure/**'
      - '.github/workflows/infrastructure-*.yml'

permissions:
  contents: read
  id-token: write
  pull-requests: write

env:
  MAX_RETRY_ATTEMPTS: 5
  RETRY_BASE_DELAY: 2

jobs:
  whatif:
    name: Bicep What-If Preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup retry utilities and policy query
        shell: bash
        run: |
          # Copy retry utilities from source
          cp scripts/ci/retry-utils.sh /tmp/retry-utils.sh
          chmod +x /tmp/retry-utils.sh
          echo "‚úÖ Retry utilities configured (max attempts: $MAX_RETRY_ATTEMPTS, base delay: ${RETRY_BASE_DELAY}s)"

          # Copy policy query utilities
          cp scripts/ci/policy-query.sh /tmp/policy-query.sh
          chmod +x /tmp/policy-query.sh
          echo "‚úÖ Policy query utilities configured"

      - name: Get managed identity from shared infrastructure
        id: get_identity
        shell: bash
        run: |
          echo "üîç Retrieving managed identity from shared infrastructure..."

          # Check if shared-identity-info.json exists
          if [ ! -f "scripts/infrastructure/shared-identity-info.json" ]; then
            echo "‚ö†Ô∏è Warning: scripts/infrastructure/shared-identity-info.json not found"
            echo "The shared infrastructure may not be set up. What-if will use empty parameter."
            echo "managed_identity_resource_id=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Extract resource ID from the JSON file
          MANAGED_IDENTITY_RESOURCE_ID=$(jq -r '.resourceId' scripts/infrastructure/shared-identity-info.json)

          if [ -z "$MANAGED_IDENTITY_RESOURCE_ID" ] || [ "$MANAGED_IDENTITY_RESOURCE_ID" == "null" ]; then
            echo "‚ö†Ô∏è Warning: Could not extract resourceId from shared-identity-info.json"
            echo "What-if will use empty parameter."
            echo "managed_identity_resource_id=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "‚úÖ Found managed identity: $MANAGED_IDENTITY_RESOURCE_ID"
          echo "managed_identity_resource_id=$MANAGED_IDENTITY_RESOURCE_ID" >> "$GITHUB_OUTPUT"

      - name: Run What-If for Dev environment
        id: whatif_dev
        continue-on-error: true
        shell: bash
        run: |
          source /tmp/retry-utils.sh

          # Function to run what-if for a specific environment and SKU
          run_whatif() {
            local env=$1
            local sku=$2
            local sku_name=$3
            local resource_group=$4
            local managed_identity_resource_id=$5

            echo "Running what-if for $env environment with $sku ($sku_name)..."

            if [ -n "$managed_identity_resource_id" ]; then
              az deployment group what-if \
                --name "whatif-$(date +%Y%m%d-%H%M%S)" \
                --resource-group "$resource_group" \
                --template-file infrastructure/main.bicep \
                --parameters infrastructure/main.bicepparam \
                --parameters environment="$env" \
                --parameters functionAppPlanSku="$sku" \
                --parameters managedIdentityResourceId="$managed_identity_resource_id" \
                --result-format FullResourcePayloads 2>&1 || true
            else
              az deployment group what-if \
                --name "whatif-$(date +%Y%m%d-%H%M%S)" \
                --resource-group "$resource_group" \
                --template-file infrastructure/main.bicep \
                --parameters infrastructure/main.bicepparam \
                --parameters environment="$env" \
                --parameters functionAppPlanSku="$sku" \
                --result-format FullResourcePayloads 2>&1 || true
            fi
          }

          RESOURCE_GROUP="rg-azure-health-dev"
          MANAGED_IDENTITY_RESOURCE_ID="${{ steps.get_identity.outputs.managed_identity_resource_id }}"

          # Create resource group if it doesn't exist (for what-if to work)
          if ! az group exists --name "$RESOURCE_GROUP" > /dev/null 2>&1; then
            echo "üì¶ Creating resource group for what-if: $RESOURCE_GROUP"
            retry_azure_operation \
              "$MAX_RETRY_ATTEMPTS" \
              "Create resource group $RESOURCE_GROUP" \
              az group create \
                --name "$RESOURCE_GROUP" \
                --location eastus \
                --tags environment=dev \
                --output none
          fi

          {
            echo "## Dev Environment What-If"
            echo ""
          } >> /tmp/whatif-summary.md

          # Run what-if for Y1 (Consumption)
          whatif_y1=$(run_whatif "dev" "Y1" "Consumption Plan" "$RESOURCE_GROUP" "$MANAGED_IDENTITY_RESOURCE_ID")

          {
            echo "### Y1 (Consumption Plan)"
            echo '```'
            echo "$whatif_y1"
            echo '```'
            echo ""
          } >> /tmp/whatif-summary.md

          # Run what-if for EP1 (Premium)
          whatif_ep1=$(run_whatif "dev" "EP1" "Elastic Premium Plan" "$RESOURCE_GROUP" "$MANAGED_IDENTITY_RESOURCE_ID")

          {
            echo "### EP1 (Elastic Premium Plan)"
            echo '```'
            echo "$whatif_ep1"
            echo '```'
            echo ""
          } >> /tmp/whatif-summary.md

      - name: Run What-If for Prod environment
        id: whatif_prod
        continue-on-error: true
        shell: bash
        run: |
          source /tmp/retry-utils.sh

          # Function to run what-if for a specific environment and SKU
          run_whatif() {
            local env=$1
            local sku=$2
            local sku_name=$3
            local resource_group=$4
            local managed_identity_resource_id=$5

            echo "Running what-if for $env environment with $sku ($sku_name)..."

            if [ -n "$managed_identity_resource_id" ]; then
              az deployment group what-if \
                --name "whatif-$(date +%Y%m%d-%H%M%S)" \
                --resource-group "$resource_group" \
                --template-file infrastructure/main.bicep \
                --parameters infrastructure/main.bicepparam \
                --parameters environment="$env" \
                --parameters functionAppPlanSku="$sku" \
                --parameters managedIdentityResourceId="$managed_identity_resource_id" \
                --result-format FullResourcePayloads 2>&1 || true
            else
              az deployment group what-if \
                --name "whatif-$(date +%Y%m%d-%H%M%S)" \
                --resource-group "$resource_group" \
                --template-file infrastructure/main.bicep \
                --parameters infrastructure/main.bicepparam \
                --parameters environment="$env" \
                --parameters functionAppPlanSku="$sku" \
                --result-format FullResourcePayloads 2>&1 || true
            fi
          }

          RESOURCE_GROUP="rg-azure-health-prod"
          MANAGED_IDENTITY_RESOURCE_ID="${{ steps.get_identity.outputs.managed_identity_resource_id }}"

          # Create resource group if it doesn't exist (for what-if to work)
          if ! az group exists --name "$RESOURCE_GROUP" > /dev/null 2>&1; then
            echo "üì¶ Creating resource group for what-if: $RESOURCE_GROUP"
            retry_azure_operation \
              "$MAX_RETRY_ATTEMPTS" \
              "Create resource group $RESOURCE_GROUP" \
              az group create \
                --name "$RESOURCE_GROUP" \
                --location eastus \
                --tags environment=prod \
                --output none
          fi

          {
            echo "## Prod Environment What-If"
            echo ""
          } >> /tmp/whatif-summary.md

          # Run what-if for Y1 (Consumption)
          whatif_y1=$(run_whatif "prod" "Y1" "Consumption Plan" "$RESOURCE_GROUP" "$MANAGED_IDENTITY_RESOURCE_ID")

          {
            echo "### Y1 (Consumption Plan)"
            echo '```'
            echo "$whatif_y1"
            echo '```'
            echo ""
          } >> /tmp/whatif-summary.md

          # Run what-if for EP1 (Premium)
          whatif_ep1=$(run_whatif "prod" "EP1" "Elastic Premium Plan" "$RESOURCE_GROUP" "$MANAGED_IDENTITY_RESOURCE_ID")

          {
            echo "### EP1 (Elastic Premium Plan)"
            echo '```'
            echo "$whatif_ep1"
            echo '```'
          } >> /tmp/whatif-summary.md

      - name: Check Policy Compliance
        id: policy_check
        continue-on-error: true
        shell: bash
        run: |
          source /tmp/policy-query.sh

          echo "üîç Checking Azure Policy compliance..."
          echo ""

          # Initialize policy summary
          {
            echo "## üõ°Ô∏è Policy Compliance Preview"
            echo ""
            echo "This preview shows current policy assignments and potential compliance issues."
            echo ""
          } >> /tmp/policy-summary.md

          # Check dev environment policies
          if az group exists --name "rg-azure-health-dev" > /dev/null 2>&1; then
            echo "### Dev Environment Policy Status"
            echo ""
            DEV_POLICY_REPORT=$(generate_policy_report "rg-azure-health-dev" 2>&1) || {
              DEV_POLICY_REPORT="‚ö†Ô∏è Unable to generate policy compliance report for dev environment."
            }
            {
              echo "### Dev Environment"
              echo ""
              echo "$DEV_POLICY_REPORT"
              echo ""
            } >> /tmp/policy-summary.md
          fi

          # Check prod environment policies
          if az group exists --name "rg-azure-health-prod" > /dev/null 2>&1; then
            echo "### Prod Environment Policy Status"
            echo ""
            PROD_POLICY_REPORT=$(generate_policy_report "rg-azure-health-prod" 2>&1) || {
              PROD_POLICY_REPORT="‚ö†Ô∏è Unable to generate policy compliance report for prod environment."
            }
            {
              echo "### Prod Environment"
              echo ""
              echo "$PROD_POLICY_REPORT"
              echo ""
            } >> /tmp/policy-summary.md
          fi

          # Add policy guidance
          {
            echo "---"
            echo ""
            echo "### üìñ Policy Guidance"
            echo ""
            echo "**If policies show Non-Compliant:**"
            echo "- Review the non-compliant resources listed above"
            echo "- Check if exemptions are needed for development/testing"
            echo "- Ensure deployments comply with organizational policies"
            echo ""
            echo "**Common Policy Issues:**"
            echo "- **Deny App Service Plan SKUs**: Y1 (Consumption) may be denied - use EP1 or request exemption"
            echo "- **Require Tags**: Ensure all resources have required tags (CostCenter, environment, etc.)"
            echo "- **Function App Authentication**: Development may need exemption for easier testing"
            echo ""
            echo "**To create a policy exemption:**"
            echo "\`\`\`bash"
            echo "az policy exemption create \\"
            echo "  --name 'exemption-name' \\"
            echo "  --display-name 'Descriptive Name' \\"
            echo "  --policy-assignment '/subscriptions/.../policyAssignments/assignment-name' \\"
            echo "  --resource-group 'rg-azure-health-dev' \\"
            echo "  --exemption-category 'Waiver' \\"
            echo "  --description 'Reason for exemption'"
            echo "\`\`\`"
          } >> /tmp/policy-summary.md

      - name: Comment PR with What-If results
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Read the what-if summary
            let summary = '';
            try {
              summary = fs.readFileSync('/tmp/whatif-summary.md', 'utf8');
            } catch (error) {
              summary = '‚ö†Ô∏è Could not generate what-if preview. Check workflow logs for details.';
            }

            // Read the policy summary
            let policySummary = '';
            try {
              policySummary = fs.readFileSync('/tmp/policy-summary.md', 'utf8');
            } catch (error) {
              policySummary = '‚ö†Ô∏è Could not generate policy compliance preview. Check workflow logs for details.';
            }

            const body = `## üîç Infrastructure What-If Preview

            This PR modifies infrastructure files. Here's a preview of what would change when deployed:

            ${summary}

            ---

            ${policySummary}

            ---

            ### SKU Comparison

            | Feature | Y1 (Consumption) | EP1 (Elastic Premium) |
            |---------|------------------|------------------------|
            | **Cost/Month** | ~$0-20 (pay per execution) | ~$146 (fixed) |
            | **Always On** | ‚ùå No (scales to zero) | ‚úÖ Yes |
            | **Cold Starts** | ‚úÖ Yes | ‚ùå No (pre-warmed) |
            | **VNet Integration** | ‚ùå No | ‚úÖ Ready |
            | **Health Check** | ‚ùå No | ‚úÖ /api/HealthCheck |
            | **Max Scale** | 200 instances | 100 instances (configurable) |

            <sub>üí° This preview shows potential changes to both **dev** and **prod** environments
            with both **Y1** and **EP1** SKU options based on the current Bicep templates, along with
            current Azure Policy compliance status.</sub>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Infrastructure What-If Preview')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
