name: Lint and Test

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint_and_test:
    name: Lint and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install PowerShell
        run: |
          wget -q https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: Install tooling modules
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Scope CurrentUser -Force
          Install-Module -Name Pester -MinimumVersion 5.4.0 -Scope CurrentUser -Force
          Install-Module -Name Az.Accounts -Scope CurrentUser -Force
          Install-Module -Name Az.Storage -Scope CurrentUser -Force
          Install-Module -Name Az.ResourceGraph -Scope CurrentUser -Force

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $results = Invoke-ScriptAnalyzer -Path ./src -Recurse -Settings ./.PSScriptAnalyzerSettings.psd1
          if ($results) {
            $errors = $results | Where-Object Severity -eq 'Error'
            if ($errors) {
              $errors | Format-Table -AutoSize | Out-String | Write-Host
              throw "PSScriptAnalyzer reported $($errors.Count) error(s)."
            }
            $warnings = $results | Where-Object Severity -eq 'Warning'
            if ($warnings) {
              $warnings | Format-Table -AutoSize | Out-String | Write-Host
            }
          }

      - name: Run Pester
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = 'tests'
          $config.Output.Verbosity = 'Detailed'
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = 'artifacts/test-results.xml'
          $config.Run.PassThru = $true

          $result = Invoke-Pester -Configuration $config
          if ($result.FailedCount -gt 0) {
            throw "Pester reported $($result.FailedCount) failure(s)."
          }

      - name: Check pricing freshness
        shell: bash
        run: |
          echo "Checking cost-config.json pricing data freshness..."

          LAST_UPDATED=$(jq -r '.lastUpdated' infrastructure/cost-config.json)
          echo "Last updated: $LAST_UPDATED"

          # Calculate age in days (portable approach for Ubuntu runners)
          LAST_UPDATED_EPOCH=$(date -d "$LAST_UPDATED" +%s 2>/dev/null || date -ud "$LAST_UPDATED" +%s 2>/dev/null || echo "0")
          CURRENT_EPOCH=$(date +%s)
          AGE_DAYS=$(( (CURRENT_EPOCH - LAST_UPDATED_EPOCH) / 86400 ))

          echo "Pricing data age: $AGE_DAYS days"

          if [ $AGE_DAYS -gt 90 ]; then
            echo "::warning file=infrastructure/cost-config.json::âš ï¸  Pricing data is $AGE_DAYS days old (>90 days). Consider updating Azure pricing."
            echo ""
            echo "ðŸ“‹ To update pricing:"
            echo "  1. Visit docs/COST_ESTIMATION.md for update instructions"
            echo "  2. Check current Azure pricing at: https://azure.microsoft.com/en-us/pricing/calculator/"
            echo "  3. Update infrastructure/cost-config.json with new prices"
            echo "  4. Update 'lastUpdated' field to current date"
          else
            echo "âœ… Pricing data is current ($AGE_DAYS days old)"
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results
          path: artifacts/test-results.xml
          retention-days: 14
